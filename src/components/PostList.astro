---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseHead from './BaseHead.astro';
import Footer from './Footer.astro';
import MathJaxHead from './MathJaxHead.astro';

type Props = { tag?: string };

const { tag } = Astro.props;

const postsOfYear = (await getCollection('posts'))
	.filter(({ data: { tags } }) => !tag || tags.includes(tag))
	.reduce(
		(acc, post) => {
			const year = post.data.date.getFullYear();
			acc[year] = [...(acc[year] || []), post];
			return acc;
		},
		{} as Record<number, CollectionEntry<'posts'>[]>,
	);

const zeroPadding = (n: number) => (n < 10 ? '0' : '') + n;
const dateString = (date: Date) => zeroPadding(date.getMonth() + 1) + '/' + zeroPadding(date.getDate());
---

<!doctype html>
<html lang='en'>
	<head>
		<BaseHead />
		<MathJaxHead />
	</head>
	<body class='mx-auto max-w-lg max-sm:px-1'>
		<nav class='mt-4 font-serif text-3xl font-extralight text-gray-700'>
			<a class='hover:text-black' href='/' target='_self'>Posts</a>
			<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-slash inline-block' viewBox='0 0 16 16'>
				<path d='M11.354 4.646a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708l6-6a.5.5 0 0 1 .708 0z'></path>
			</svg>
			{
				tag && (
					<a href={`/tagged/${tag}/`} target='_self' class='hover:text-black'>
						#{tag}
					</a>
				)
			}
		</nav>
		<div class='flex flex-col items-stretch font-body'>
			{
				Object.entries(postsOfYear)
					.sort(([a], [b]) => Number(b) - Number(a))
					.map(([year, posts]) => (
						<>
							<h2 class='mt-4 text-xl text-gray-400'>{year}</h2>
							<hr />
							{posts
								.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
								.map(({ slug, data: { title, date } }) => (
									<div class='mt-2 flex items-baseline justify-between'>
										<a class='text-lg' href={`/post/${slug}/`}>
											{title}
										</a>
										<time class='text-nowrap text-gray-400' datetime={date.toISOString()}>
											{dateString(date)}
										</time>
									</div>
								))}
						</>
					))
			}
		</div>
		<Footer />
	</body>
</html>
